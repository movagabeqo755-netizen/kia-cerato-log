<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kia Cerato 1 Log</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #000000);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #8e8e93);
            --link-color: var(--tg-theme-link-color, #0a84ff);
            --button-color: var(--tg-theme-button-color, #0a84ff);
            --button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --kia-red: #ff3b30;
            --delete-color: #ff453a;
            --green-color: #32d74b;
            --yellow-color: #ffd60a;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body {
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ñ–æ—Ç–æ */
        .app-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .app-header-image {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--secondary-bg);
            background-color: var(--secondary-bg);
        }
        .header-text {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
        }

        h1 { margin: 0 0 8px 0; font-size: 24px; font-weight: 800; letter-spacing: 0.3px; line-height: 1.1; }

        /* –ë–ª–æ–∫ —Å –Ω–æ–º–µ—Ä–æ–º –∏ –ø—Ä–æ–±–µ–≥–æ–º */
        .car-info-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* –ù–æ–º–µ—Ä–Ω–æ–π –∑–Ω–∞–∫ */
        .license-plate {
            display: inline-flex;
            align-items: center;
            background-color: white;
            color: black;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0;
            font-family: "Condensed", sans-serif;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
            height: 28px;
        }
        .plate-number { padding: 0 5px; letter-spacing: 1px; font-size: 16px; text-transform: uppercase; }
        .plate-region { border-left: 1px solid black; padding: 0 3px; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 0.9; height: 100%; }
        .region-code { font-size: 10px; }
        .plate-flag { display: flex; align-items: center; font-size: 6px; }

        /* –û–î–û–ú–ï–¢–† (–ù–û–í–û–ï) */
        .odometer-badge {
            background-color: var(--secondary-bg);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 0 8px;
            height: 28px;
            display: flex;
            align-items: center;
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
            cursor: pointer;
        }
        .odometer-icon { margin-right: 4px; font-size: 12px; color: var(--hint-color); }

        .subtitle-archive { color: var(--hint-color); font-size: 15px; margin-bottom: 24px; }

        /* –í–ò–î–ñ–ï–¢ –ú–ê–°–õ–ê */
        .oil-widget {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .oil-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .oil-title {
            font-size: 13px;
            text-transform: uppercase;
            color: var(--hint-color);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .oil-icon { font-size: 18px; }
        
        .oil-info { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
        .oil-left-big { font-size: 28px; font-weight: 800; color: var(--text-color); line-height: 1; }
        .oil-left-label { font-size: 13px; color: var(--hint-color); margin-top: 4px; }
        .oil-target { font-size: 13px; color: var(--link-color); font-weight: 600; text-align: right; }

        .oil-progress-bg {
            height: 6px;
            width: 100%;
            background-color: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .oil-progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--green-color);
            border-radius: 3px;
            transition: width 0.5s ease, background-color 0.5s ease;
        }
        .oil-last-km {
            font-size: 11px;
            color: var(--hint-color);
            margin-top: 6px;
            text-align: right;
        }

        /* –í–≤–æ–¥ */
        .input-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 0 16px;
            margin-bottom: 24px;
        }
        .input-row {
            border-bottom: 0.5px solid rgba(128, 128, 128, 0.2);
            padding: 12px 0;
            display: flex;
            flex-direction: column;
        }
        .input-row:last-child { border-bottom: none; }
        label { display: block; font-size: 13px; color: var(--hint-color); margin-bottom: 6px; }
        input, select { width: 100%; background: transparent; border: none; color: var(--text-color); font-size: 17px; outline: none; padding: 0; font-family: inherit;}
        select { -webkit-appearance: none; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .page-save-btn {
            width: 100%;
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .page-save-btn:active { opacity: 0.8; }

        .backup-btn { background-color: var(--secondary-bg); color: var(--link-color); margin-top: 15px; border: 1px solid var(--link-color); }
        .restore-btn { background-color: var(--secondary-bg); color: var(--kia-red); margin-top: 10px; border: 1px solid var(--kia-red); }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .log-item-wrapper { position: relative; margin-bottom: 12px; border-radius: 12px; overflow: hidden; background-color: var(--delete-color); }
        .log-item { background-color: var(--secondary-bg); padding: 16px; position: relative; z-index: 10; transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); border-radius: 12px; will-change: transform; }
        .log-item.swiped { transform: translateX(-90px); }
        .swipe-delete-text { position: absolute; top: 0; right: 0; width: 90px; height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 15px; z-index: 1; }
        .log-top { display: flex; justify-content: space-between; margin-bottom: 6px; align-items: baseline;}
        .log-date { font-size: 13px; color: var(--hint-color); }
        .log-cost { color: var(--kia-red); font-weight: 600; font-size: 16px;}
        .log-part { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
        .log-details { font-size: 14px; color: var(--hint-color); }

        /* –û –ø—Ä–æ–≥—Ä–∞–º–º–µ */
        .about-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60%; text-align: center; }
        .about-card-info { background-color: var(--secondary-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 320px; margin-bottom: 20px; }
        .creator-name { color: var(--text-color); font-weight: 600; }
        .warning-text { font-size: 12px; color: var(--hint-color); margin-top: 20px; line-height: 1.4; }

        /* –ú–µ–Ω—é */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-around;
            padding-top: 10px;
            padding-bottom: calc(5px + env(safe-area-inset-bottom));
            border-top: 0.5px solid rgba(128, 128, 128, 0.2);
            z-index: 100;
        }
        .tab-btn { background: none; border: none; color: var(--hint-color); font-size: 10px; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .tab-btn.active { color: var(--button-color); }
        .tab-icon { font-size: 22px; margin-bottom: 4px; }
        
        .screen { display: none; opacity: 0; transition: opacity 0.2s; }
        .screen.active { display: block; opacity: 1; }
    </style>
</head>
<body>

    <div id="screen-garage" class="screen active content">
        <div class="app-header">
            <img src="car.jpg" onerror="this.src='https://img.icons8.com/ios-filled/100/8e8e93/car.png'" alt="Kia" class="app-header-image">
            <div class="header-text">
                <h1>Kia Cerato 1</h1>
                
                <div class="car-info-row">
                    <div class="license-plate" onclick="editPlate()">
                        <div class="plate-number" id="plate-text">–ê 463 –†–ù</div>
                        <div class="plate-region">
                            <div class="region-code" id="region-text">82</div>
                            <div class="plate-flag">RUS <span class="flag-icon">üá∑üá∫</span></div>
                        </div>
                    </div>
                    
                    <div class="odometer-badge" onclick="editOdometer()">
                        <span class="odometer-icon">km</span>
                        <span id="header-odometer">295 000</span>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="oil-widget" onclick="editOilSettings()">
            <div class="oil-header">
                <span class="oil-title">–î–æ –∑–∞–º–µ–Ω—ã –º–∞—Å–ª–∞</span>
                <span class="oil-icon">‚öôÔ∏è</span>
            </div>
            <div class="oil-info">
                <div>
                    <div class="oil-left-big" id="oil-remaining-text">--</div>
                    <div class="oil-left-label">–æ—Å—Ç–∞–ª–æ—Å—å –∫–º</div>
                </div>
                <div>
                     <div class="oil-target" id="oil-next-text">–°–ª–µ–¥: -- –∫–º</div>
                     <div class="oil-last-km" id="oil-last-text">–ó–∞–º–µ–Ω–∞: -- –∫–º</div>
                </div>
            </div>
            <div class="oil-progress-bg">
                <div class="oil-progress-fill" id="oil-progress" style="width: 0%"></div>
            </div>
        </div>

        <div class="input-card">
            <div class="input-row">
                <label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
                <input type="number" id="inp-mileage" placeholder="295000">
            </div>
            <div class="input-row">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="inp-category">
                    <option value="–¢–û">–¢–û (–ú–∞—Å–ª–æ/–§–∏–ª—å—Ç—Ä—ã)</option>
                    <option value="–ü–æ–¥–≤–µ—Å–∫–∞">–ü–æ–¥–≤–µ—Å–∫–∞</option>
                    <option value="–î–≤–∏–≥–∞—Ç–µ–ª—å">–î–≤–∏–≥–∞—Ç–µ–ª—å / –ì–†–ú</option>
                    <option value="–¢–æ—Ä–º–æ–∑–∞">–¢–æ—Ä–º–æ–∑–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</option>
                    <option value="–≠–ª–µ–∫—Ç—Ä–∏–∫–∞">–≠–ª–µ–∫—Ç—Ä–∏–∫–∞</option>
                    <option value="–ö—É–∑–æ–≤">–ö—É–∑–æ–≤ / –°–∞–ª–æ–Ω</option>
                    <option value="–®–∏–Ω—ã">–®–∏–Ω—ã / –î–∏—Å–∫–∏</option>
                    <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="input-row">
                <label>–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ</label>
                <input type="text" id="inp-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç">
            </div>
            <div class="input-row">
                <label>–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                <input type="number" id="inp-cost" placeholder="0">
            </div>
            <div class="input-row">
                <label>–ó–∞–º–µ—Ç–∫–∏</label>
                <input type="text" id="inp-notes" placeholder="–ë—Ä–µ–Ω–¥, –∞—Ä—Ç–∏–∫—É–ª...">
            </div>
        </div>

        <button id="visible-save-btn" class="page-save-btn" onclick="saveRecord()">–°–û–•–†–ê–ù–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
    </div>

    <div id="screen-archive" class="screen content">
        <h1>–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–∞</h1>
        <div class="subtitle-archive" id="total-spent">–í—Å–µ–≥–æ: 0 ‚ÇΩ</div>
        <div id="logs-container"></div>
    </div>

    <div id="screen-about" class="screen content">
        <h1>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h1>
        <div class="about-container">
            <div class="about-card-info">
                <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">–í–µ—Ä—Å–∏—è 12.0</div>
                <div style="color:var(--hint-color); font-size:15px; margin-bottom:20px;">
                    –°–æ–∑–¥–∞—Ç–µ–ª—å: <span class="creator-name">romerioyalta</span>
                </div>
                <hr style="border:0; border-top:1px solid rgba(128,128,128,0.2); margin: 15px 0;">
                <button class="page-save-btn backup-btn" onclick="exportData()">üì§ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="page-save-btn restore-btn" onclick="importData()">üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏</button>
                <p class="warning-text">–í–Ω–∏–º–∞–Ω–∏–µ! –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¢–µ–ª–µ–≥—Ä–∞–º–∞ –¥–∞–Ω–Ω—ã–µ –∏—Å—á–µ–∑–Ω—É—Ç. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–ø–∏—é.</p>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('garage')"><span class="tab-icon">üõ†</span><span>–ì–∞—Ä–∞–∂</span></button>
        <button class="tab-btn" onclick="switchTab('archive')"><span class="tab-icon">üìã</span><span>–ò—Å—Ç–æ—Ä–∏—è</span></button>
        <button class="tab-btn" onclick="switchTab('about')"><span class="tab-icon">‚ÑπÔ∏è</span><span>–ò–Ω—Ñ–æ</span></button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const themeBg = tg.themeParams.bg_color || "#000000";
        const themeButton = tg.themeParams.button_color || "#0a84ff";
        tg.setHeaderColor(themeBg);
        tg.setBackgroundColor(themeBg);
        
        const STORAGE_KEY = 'kia_tg_log_v2';
        const PLATE_KEY = 'kia_plate_number';
        const OIL_KEY = 'kia_oil_config_v3';
        const ODO_KEY = 'kia_current_odometer'; // –ù–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –æ–¥–æ–º–µ—Ç—Ä–∞

        let logs = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let oilConfig = JSON.parse(localStorage.getItem(OIL_KEY)) || { lastKm: 0, interval: 7000 };
        let currentOdometer = parseInt(localStorage.getItem(ODO_KEY)) || (logs.length > 0 ? parseInt(logs[0].mileage) : 0);
        let editingId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadPlate();
        updateOdometerDisplay();
        updateOilWidget();
        document.getElementById('inp-mileage').value = currentOdometer;

        function switchTab(tab) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            tg.HapticFeedback.selectionChanged();

            if (tab === 'garage') {
                document.getElementById('screen-garage').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                updateButtonsState();
                updateOilWidget();
                // –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –≥–∞—Ä–∞–∂ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –æ–¥–æ–º–µ—Ç—Ä–∞, –µ—Å–ª–∏ –æ–Ω–æ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å—Ç–∞—Ä–æ–µ
                if (!editingId) {
                     document.getElementById('inp-mileage').value = currentOdometer;
                }
            } else {
                exitEditMode();
                if(tab === 'archive') {
                    document.getElementById('screen-archive').classList.add('active');
                    document.querySelectorAll('.tab-btn')[1].classList.add('active');
                    renderLogs();
                } else {
                    document.getElementById('screen-about').classList.add('active');
                    document.querySelectorAll('.tab-btn')[2].classList.add('active');
                }
            }
        }

        function saveRecord() {
            const mileage = document.getElementById('inp-mileage').value;
            const title = document.getElementById('inp-title').value;
            const costStr = document.getElementById('inp-cost').value;
            
            if (!mileage || !title) {
                tg.showPopup({title: '–û—à–∏–±–∫–∞', message: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–±–µ–≥ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç'});
                return;
            }

            const recordData = {
                id: editingId || Date.now(),
                date: editingId ? getLogById(editingId).date : new Date().toLocaleDateString('ru-RU'),
                mileage: mileage,
                category: document.getElementById('inp-category').value,
                title: title,
                cost: costStr ? parseInt(costStr.replace(/\D/g,'')) : 0,
                notes: document.getElementById('inp-notes').value
            };

            if (editingId) {
                logs = logs.map(l => l.id === editingId ? recordData : l);
            } else {
                logs.unshift(recordData);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –æ–¥–æ–º–µ—Ç—Ä, –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø—Ä–æ–±–µ–≥ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ
            if (parseInt(mileage) > currentOdometer) {
                currentOdometer = parseInt(mileage);
                localStorage.setItem(ODO_KEY, currentOdometer);
                updateOdometerDisplay();
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            clearForm();
            exitEditMode();
            tg.HapticFeedback.notificationOccurred('success');
            tg.showPopup({message: editingId ? '–û–±–Ω–æ–≤–ª–µ–Ω–æ!' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!'});
            
            updateOilWidget(); 
        }

        // --- –õ–û–ì–ò–ö–ê –ú–ê–°–õ–ê (–°–í–Ø–ó–ê–ù–ê –° –û–î–û–ú–ï–¢–†–û–ú) ---
        function updateOilWidget() {
            // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º currentOdometer –≤–º–µ—Å—Ç–æ logs[0]
            const lastOilKm = parseInt(oilConfig.lastKm);
            const interval = parseInt(oilConfig.interval);
            
            if (lastOilKm === 0) {
                document.getElementById('oil-remaining-text').innerText = "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å";
                document.getElementById('oil-next-text').innerText = "–ñ–º–∏ —Å—é–¥–∞";
                document.getElementById('oil-last-text').innerText = "";
                document.getElementById('oil-progress').style.width = "0%";
                return;
            }

            const nextOilKm = lastOilKm + interval;
            const remaining = nextOilKm - currentOdometer;
            
            // –†–∞—Å—á–µ—Ç –ø–æ–ª–æ—Å–∫–∏
            let percentLeft = (remaining / interval) * 100;
            if (percentLeft > 100) percentLeft = 100;
            if (percentLeft < 0) percentLeft = 0;

            const bar = document.getElementById('oil-progress');
            if (percentLeft > 40) bar.style.backgroundColor = "var(--green-color)";
            else if (percentLeft > 15) bar.style.backgroundColor = "var(--yellow-color)";
            else bar.style.backgroundColor = "var(--kia-red)";
            bar.style.width = percentLeft + "%";

            if (remaining <= 0) {
                // –ï—Å–ª–∏ –ø–µ—Ä–µ–ø—Ä–æ–±–µ–≥
                document.getElementById('oil-remaining-text').innerText = "–ú–µ–Ω—è–π!";
                document.getElementById('oil-remaining-text').style.color = "var(--kia-red)";
            } else {
                document.getElementById('oil-remaining-text').innerText = new Intl.NumberFormat('ru-RU').format(remaining);
                document.getElementById('oil-remaining-text').style.color = "var(--text-color)";
            }
            
            document.getElementById('oil-next-text').innerText = `–°–ª–µ–¥: ${new Intl.NumberFormat('ru-RU').format(nextOilKm)} –∫–º`;
            document.getElementById('oil-last-text').innerText = `–ó–∞–º–µ–Ω–∞: ${new Intl.NumberFormat('ru-RU').format(lastOilKm)} –∫–º`;
        }

        function editOilSettings() {
            const newLast = prompt("–®–ê–ì 1: –ù–∞ –∫–∞–∫–æ–º –ø—Ä–æ–±–µ–≥–µ –≤—ã –º–µ–Ω—è–ª–∏ –º–∞—Å–ª–æ? (–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ)", oilConfig.lastKm || "");
            
            if (newLast !== null && newLast.trim() !== "") {
                const l = parseInt(newLast.replace(/\D/g,''));
                if (isNaN(l)) { alert("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ!"); return; }

                const newInt = prompt("–®–ê–ì 2: –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∫–º –º–µ–Ω—è—Ç—å? (–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ)", oilConfig.interval || "7000");
                
                if (newInt !== null && newInt.trim() !== "") {
                    const i = parseInt(newInt.replace(/\D/g,''));
                    if (isNaN(i)) { alert("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ!"); return; }

                    oilConfig = { lastKm: l, interval: i };
                    localStorage.setItem(OIL_KEY, JSON.stringify(oilConfig));
                    updateOilWidget();
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
        }

        // --- –õ–û–ì–ò–ö–ê –û–î–û–ú–ï–¢–†–ê (–ù–û–í–ê–Ø) ---
        function updateOdometerDisplay() {
            document.getElementById('header-odometer').innerText = new Intl.NumberFormat('ru-RU').format(currentOdometer);
        }

        function editOdometer() {
             const newVal = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:", currentOdometer);
             if (newVal !== null && newVal.trim() !== "") {
                 const parsed = parseInt(newVal.replace(/\D/g,''));
                 if (!isNaN(parsed)) {
                     currentOdometer = parsed;
                     localStorage.setItem(ODO_KEY, currentOdometer);
                     updateOdometerDisplay();
                     updateOilWidget(); // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å–ª–æ
                     document.getElementById('inp-mileage').value = currentOdometer; // –ò –ø–æ–ª–µ –≤–≤–æ–¥–∞
                     tg.HapticFeedback.notificationOccurred('success');
                 }
             }
        }

        // --- –û–°–¢–ê–õ–¨–ù–û–ï ---
        function updateButtonsState() {
            const btn = document.getElementById('visible-save-btn');
            if (editingId) {
                btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø";
                btn.style.backgroundColor = "#34c759";
            } else {
                btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –ó–ê–ü–ò–°–¨";
                btn.style.backgroundColor = themeButton;
            }
        }
        window.startEdit = function(id) {
            const log = getLogById(id);
            if (!log) return;
            editingId = id;
            document.getElementById('inp-mileage').value = log.mileage;
            document.getElementById('inp-category').value = log.category;
            document.getElementById('inp-title').value = log.title;
            document.getElementById('inp-cost').value = log.cost;
            document.getElementById('inp-notes').value = log.notes;
            switchTab('garage');
        }
        function exitEditMode() {
            editingId = null;
            updateButtonsState();
            if(!document.getElementById('inp-mileage').value) {
                 document.getElementById('inp-mileage').value = currentOdometer;
            }
        }
        function clearForm() {
            document.getElementById('inp-title').value = '';
            document.getElementById('inp-cost').value = '';
            document.getElementById('inp-notes').value = '';
        }
        function getLogById(id) { return logs.find(l => l.id === id); }
        function renderLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            let total = 0;
            if (logs.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:gray;margin-top:40px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>';
                document.getElementById('total-spent').innerText = '–í—Å–µ–≥–æ: 0 ‚ÇΩ';
                return;
            }
            logs.forEach(log => {
                total += log.cost;
                const wrapper = document.createElement('div');
                wrapper.className = 'log-item-wrapper';
                wrapper.innerHTML = `<div class="swipe-delete-text" onclick="deleteLogConfirm(${log.id})">–£–¥–∞–ª–∏—Ç—å</div>`;
                const el = document.createElement('div');
                el.className = 'log-item';
                el.onclick = () => startEdit(log.id);
                el.innerHTML = `
                    <div class="log-top">
                        <span class="log-date">${log.date}</span>
                        <span style="font-weight:600; font-size:15px;">${log.mileage} –∫–º</span>
                    </div>
                    <div class="log-part">${log.title}</div>
                    <div class="log-details">${log.category} ${log.notes ? '‚Ä¢ '+log.notes : ''}</div>
                    <span class="log-cost">${new Intl.NumberFormat('ru-RU').format(log.cost)} ‚ÇΩ</span>
                `;
                enableSwipe(el);
                wrapper.appendChild(el);
                container.appendChild(wrapper);
            });
            document.getElementById('total-spent').innerText = `–í—Å–µ–≥–æ: ${new Intl.NumberFormat('ru-RU').format(total)} ‚ÇΩ`;
        }
        function enableSwipe(element) {
            let startX = 0; let startY = 0; let isSwiping = false;
            element.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; startY = e.changedTouches[0].screenY; isSwiping = false; }, {passive: true});
            element.addEventListener('touchmove', e => {
                 const diffX = startX - e.changedTouches[0].screenX;
                 const diffY = startY - e.changedTouches[0].screenY;
                 if (Math.abs(diffX) > Math.abs(diffY)) { isSwiping = true; if(Math.abs(diffX) > 5) e.preventDefault(); }
            }, {passive: false});
            element.addEventListener('touchend', e => {
                if (!isSwiping) return; 
                if (e.changedTouches[0].screenX + 60 < startX) {
                    document.querySelectorAll('.log-item.swiped').forEach(i => i.classList.remove('swiped'));
                    element.classList.add('swiped');
                    tg.HapticFeedback.impactOccurred('light');
                } else if (e.changedTouches[0].screenX > startX - 60) {
                    element.classList.remove('swiped');
                }
            }, {passive: true});
        }
        document.addEventListener('click', e => { if (!e.target.closest('.log-item-wrapper')) document.querySelectorAll('.log-item.swiped').forEach(i => i.classList.remove('swiped')); });
        function deleteLogConfirm(id) {
             if (tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0) {
                 tg.showConfirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?", function(ok) { if (ok) { logs = logs.filter(l => l.id !== id); localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); renderLogs(); updateOilWidget(); tg.HapticFeedback.notificationOccurred('success'); } else renderLogs(); });
             } else {
                 if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –Ω–∞–≤—Å–µ–≥–¥–∞?")) { logs = logs.filter(l => l.id !== id); localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); renderLogs(); updateOilWidget(); } else renderLogs();
             }
        }
        function loadPlate() {
            const savedPlate = localStorage.getItem(PLATE_KEY);
            if (savedPlate) {
                const parts = savedPlate.split('|');
                if (parts.length === 2) {
                    document.getElementById('plate-text').innerText = parts[0];
                    document.getElementById('region-text').innerText = parts[1];
                }
            }
        }
        function editPlate() {
            tg.showPopup({ title: '–°–º–µ–Ω–∏—Ç—å –≥–æ—Å–Ω–æ–º–µ—Ä', message: '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ —Ä–µ–≥–∏–æ–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê463–†–ù 82)', buttons: [{type: 'ok', id: 'save'}, {type: 'cancel'}] }, function(btn) {
                if (btn === 'save') {
                    setTimeout(() => {
                        const input = prompt("–í–≤–µ–¥–∏—Ç–µ –≥–æ—Å–Ω–æ–º–µ—Ä (–ù–∞–ø—Ä–∏–º–µ—Ä: –ê463–†–ù 82):", document.getElementById('plate-text').innerText + " " + document.getElementById('region-text').innerText);
                        if (input) {
                            const clean = input.trim().toUpperCase();
                            const match = clean.match(/^(.+?)\s*(\d{2,3})$/); 
                            if (match) {
                                const newNum = match[1].replace(/\s/g, ''); const newReg = match[2];
                                document.getElementById('plate-text').innerText = newNum; document.getElementById('region-text').innerText = newReg;
                                localStorage.setItem(PLATE_KEY, newNum + '|' + newReg);
                            } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");
                        }
                    }, 100);
                }
            });
        }
        // –ë—ç–∫–∞–ø
        function exportData() {
            const data = JSON.stringify(logs);
            navigator.clipboard.writeText(data).then(() => { tg.showPopup({ title: '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', message: '–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –≤ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ.' }); tg.HapticFeedback.notificationOccurred('success'); }).catch(err => { prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:", data); });
        }
        function importData() {
             setTimeout(() => { const input = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"); if (input && input.startsWith('[')) { if(confirm("–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ?")) { localStorage.setItem(STORAGE_KEY, input); logs = JSON.parse(input); renderLogs(); updateOilWidget(); tg.showPopup({message: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!'}); } } }, 100);
        }
    </script>
</body>
</html>
